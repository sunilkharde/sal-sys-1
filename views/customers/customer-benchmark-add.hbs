<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10 border p-4">
            <h4 class="mb-3">Add Customer Benchmark</h4>

            {{#if errors}}
            <div class="alert alert-danger">
                {{#each errors}}
                <div>{{this.message}}</div>
                {{/each}}
            </div>
            {{/if}}

            <form action="/customer/benchmark/add" method="post">
                <!-- Main Customer Selection -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5>Main Customer</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <label for="main_district" class="col-sm-3 col-form-label">District<span
                                    style="color: red;">*</span></label>
                            <div class="col-sm-9">
                                <select class="form-select" id="main_district" name="main_district" required>
                                    <option value="">-- Select District --</option>
                                    {{#each districts}}
                                    <option value="{{this.district_name}}">{{this.district_name}}</option>
                                    {{/each}}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="main_city" class="col-sm-3 col-form-label">City<span
                                    style="color: red;">*</span></label>
                            <div class="col-sm-9">
                                <select class="form-select" id="main_city" name="main_city" required disabled>
                                    <option value="">-- Select City --</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="customer_id" class="col-sm-3 col-form-label">Customer<span
                                    style="color: red;">*</span></label>
                            <div class="col-sm-9">
                                <select class="form-select" id="customer_id" name="customer_id" required disabled>
                                    <option value="">-- Select Customer --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Benchmark Customer Selection -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5>Benchmark Customer</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <label for="bench_district" class="col-sm-3 col-form-label">District<span
                                    style="color: red;">*</span></label>
                            <div class="col-sm-9">
                                <select class="form-select" id="bench_district" name="bench_district" required>
                                    <option value="">-- Select District --</option>
                                    {{#each districts}}
                                    <option value="{{this.district_name}}">{{this.district_name}}</option>
                                    {{/each}}
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="bench_city" class="col-sm-3 col-form-label">City<span
                                    style="color: red;">*</span></label>
                            <div class="col-sm-9">
                                <select class="form-select" id="bench_city" name="bench_city" required disabled>
                                    <option value="">-- Select City --</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <label for="cust_bench_id" class="col-sm-3 col-form-label">Customer<span
                                    style="color: red;">*</span></label>
                            <div class="col-sm-9">
                                <select class="form-select" id="cust_bench_id" name="cust_bench_id" required disabled>
                                    <option value="">-- Select Customer --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-sm-9 offset-sm-3">
                        <button type="submit" class="btn btn-primary">Submit</button>
                        <button type="button" class="btn btn-secondary"
                            onclick="window.location.href='/customer/benchmark'">Cancel</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Function to fetch cities for a district
        function fetchCities(district, targetSelect) {
            if (!district) {
                $(targetSelect).prop('disabled', true).html('<option value="">-- Select City --</option>');
                return;
            }

            console.log('Fetching cities for district:', district); // Debug log

            $.ajax({
                url: '/customer/benchmark/cities',
                method: 'GET',
                data: { district: district },
                success: function (cities) {
                    console.log('Received cities:', cities); // Debug log
                    $(targetSelect).prop('disabled', false).html('<option value="">-- Select City --</option>');
                    cities.forEach(city => {
                        $(targetSelect).append(`<option value="${city.city}">${city.city}</option>`);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Failed to fetch cities:", error, xhr.responseText);
                    $(targetSelect).prop('disabled', false)
                        .html('<option value="">-- Error loading cities --</option>');
                }
            });
        }

        // Function to fetch customers for a city
        function fetchCustomers(district, city, targetSelect) {
            if (!city) {
                $(targetSelect).prop('disabled', true).html('<option value="">-- Select Customer --</option>');
                return;
            }

            console.log('Fetching customers for district:', district, 'city:', city); // Debug log

            $.ajax({
                url: '/customer/benchmark/customers',
                method: 'GET',
                data: { district: district, city: city },
                success: function (customers) {
                    console.log('Received customers:', customers); // Debug log
                    $(targetSelect).prop('disabled', false).html('<option value="">-- Select Customer --</option>');
                    customers.forEach(customer => {
                        $(targetSelect).append(`<option value="${customer.customer_id}">${customer.customer_name}</option>`);
                    });
                },
                error: function (xhr, status, error) {
                    console.error("Failed to fetch customers:", error, xhr.responseText);
                    $(targetSelect).prop('disabled', false)
                        .html('<option value="">-- Error loading customers --</option>');
                }
            });
        }

        // Main Customer Selection
        $('#main_district').change(function () {
            const district = $(this).val();
            fetchCities(district, '#main_city');
            $('#customer_id').prop('disabled', true).html('<option value="">-- Select Customer --</option>');
        });

        $('#main_city').change(function () {
            const district = $('#main_district').val();
            const city = $(this).val();
            fetchCustomers(district, city, '#customer_id');
        });

        // Benchmark Customer Selection
        $('#bench_district').change(function () {
            const district = $(this).val();
            fetchCities(district, '#bench_city');
            $('#cust_bench_id').prop('disabled', true).html('<option value="">-- Select Customer --</option>');
        });

        $('#bench_city').change(function () {
            const district = $('#bench_district').val();
            const city = $(this).val();
            fetchCustomers(district, city, '#cust_bench_id');
        });

    });
</script>