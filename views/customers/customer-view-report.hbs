<div class="container">

    <!-- Customer Information Section -->
    <div class="row justify-content-center">
        <div class="col-lg-11 border p-4 rounded shadow-sm bg-light">

            <!-- Header Row -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                <h4 class="mb-2 mb-md-0">
                    Customer: - {{data.customer_name}} ({{data.ext_code}})
                </h4>
                <div>
                    <a href="/customer/update-info/{{data.customer_id}}" class="btn btn-sm btn-primary me-2">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <button class="btn btn-sm btn-success" onclick="window.print()">
                        <i class="bi bi-printer"></i> Print
                    </button>
                </div>
            </div>

            <!-- Information Grid -->
            <div class="row g-3">
                <!-- Basic Info -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">Firm Name:</label>
                    <div>{{data.customer_name}}</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Contact Person:</label>
                    <div>{{data.nick_name}}</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Contact Number:</label>
                    <div>{{data.cust_care_no}}</div>
                </div>

                <!-- Address Info -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">Office Address:</label>
                    <div>{{data.add1}}</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Godown Address:</label>
                    <div>{{data.add2}} {{data.add3}}</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Location:</label>
                    <div>{{data.city}} - {{data.pin_code}}, {{data.district}}, {{data.state}}</div>
                </div>

                <!-- Business Info -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">GST Number:</label>
                    <div>{{data.gst_no}}</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Godown Area:</label>
                    <div>{{data.godown_area}} sq.ft.</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Counters:</label>
                    <div>{{data.total_counters}}</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Market Area:</label>
                    <div>{{data.market_area}}</div>
                </div>

                <!-- Sales Info & Photo -->
                <div class="col-md-4">
                    <label class="form-label fw-bold">Sales Manager:</label>
                    <div>{{data.mg_name}}</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Sales Executive:</label>
                    <div>{{data.se_name}}</div>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Proprietor Photo:</label>
                    <div>
                        <img src="{{data.geo_location}}" alt="Customer Photo" class="img-thumbnail mt-1"
                            style="max-width: 100px;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Performance Section -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-11 border p-4 rounded">
            <h4 class="mb-3">Performance Parameters</h4>

            <!-- Date Range Filter -->
            <form method="get" action="/customer/view-report/{{data.customer_id}}" class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="from_date" class="form-label">From Date</label>
                    <input type="date" class="form-control" id="from_date" name="from_date" value="{{from_date}}">
                </div>
                <div class="col-md-3">
                    <label for="to_date" class="form-label">To Date</label>
                    <input type="date" class="form-control" id="to_date" name="to_date" value="{{to_date}}">
                </div>
                <div class="col-md-3">
                    <label for="material_group" class="form-label">Product Category</label>
                    <select class="form-select" id="material_group" name="material_group">
                        <option value="">All Categories</option>
                        {{#each material_groups}}
                        <option value="{{this.value}}" {{#isEqual this.value ../selected_material_group}}selected{{/isEqual}}>
                            {{this.label}}
                        </option>
                        {{/each}}
                    </select>
                    
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Apply Filter</button>
                    <a href="/customer/view-report/{{data.customer_id}}" class="btn btn-outline-secondary">Reset</a>
                </div>
            </form>

        </div>
    </div>

    <!-- Add Benchmark Comparison Section -->
    {{#if benchmarkComparison.length}}
    <div class="row justify-content-center mt-4">
        <div class="col-lg-11 border p-4 rounded">
            <h4 class="mb-3">Category-wise Benchmark Comparison (Quantity in Bags)</h4>

            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th rowspan="2">Category</th>
                            <th colspan="2" class="text-center">Current Customer</th>
                            {{#each benchmarkData}}
                            <th colspan="2" class="text-center"> {{!-- {{this.customer_name}} --}} ({{this.city}})</th>
                            {{/each}}

                        </tr>
                        <tr>
                            <th colspan="2" class="text-end">Qty (Bags)</th>
                            {{!-- <th class="text-end">%</th> --}}
                            {{#each benchmarkData}}
                            <th colspan="2" class="text-end">Qty (Bags)</th>
                            {{!-- <th class="text-end">% Diff</th> --}}
                            {{/each}}
                        </tr>
                    </thead>
                    <tbody>
                        {{#each benchmarkComparison}}
                        <tr>
                            <td>{{this.material_group_description}}</td>
                            <td colspan="2" class="text-end">{{formatNumber this.current_customer.quantity}}</td>
                            {{!-- <td class="text-end">100%</td> --}}
                            {{#each this.benchmarks}}
                            <td colspan="2" class="text-end">{{formatNumber this.quantity}}</td>
                            {{!-- <td
                                class="text-end {{#if (gt this.quantity ../current_customer.quantity)}}text-danger{{else}}text-success{{/if}}">
                                {{#if (gt this.quantity ../current_customer.quantity)}}
                                +{{formatNumber (multiply (divide (subtract this.quantity
                                ../current_customer.quantity) ../current_customer.quantity) 100)}}%
                                {{else}}
                                -{{formatNumber (multiply (divide (subtract ../current_customer.quantity
                                this.quantity) ../current_customer.quantity) 100)}}%
                                {{/if}}
                            </td> --}}
                            {{/each}}
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {{/if}}

    <!-- Benchmark Competitors Section -->
    {{#if benchmarkData.length}}
    <div class="row justify-content-center mt-4">
        <div class="col-lg-11 border p-4 rounded">
            <h4 class="mb-3">Benchmark Competitors</h4>

            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Competitor Name</th>
                            <th class="text-end">Total Quantity</th>
                            <th class="text-end">vs Your Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each benchmarkData}}
                        <tr>
                            <td>{{add @index 1}}</td>
                            <td>{{this.customer_name}}</td>
                            <td class="text-end">{{formatNumber this.total_quantity}}</td>
                            <td class="text-end">
                                {{#if ../currentCustomerRank}}
                                {{#if (gt this.total_quantity ../currentCustomerRank.total_quantity)}}
                                <span class="text-danger">+{{formatNumber (subtract this.total_quantity
                                    ../currentCustomerRank.total_quantity)}}</span>
                                {{else}}
                                <span class="text-success">-{{formatNumber (subtract
                                    ../currentCustomerRank.total_quantity
                                    this.total_quantity)}}</span>
                                {{/if}}
                                {{/if}}
                            </td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {{/if}}

    <!-- Customer Ranking Section -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-11 border p-4 rounded">
            <h4 class="mb-3">Market Area Performance</h4>

            {{#if currentCustomerRank}}
            <div class="alert alert-info">
                <strong>Your Rank:</strong> #{{currentCustomerRank.sales_rank}} in market area
                with total quantity of {{formatNumber currentCustomerRank.total_quantity}} Bags
                {{!-- ({{formatCurrency currentCustomerRank.total_sales}}) --}}
            </div>
            {{/if}}

            <div class="table-responsive">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Rank</th>
                                <th>Customer Name</th>
                                <th class="text-end">Qty (Bags)</th>
                                <th class="text-end">Total Sales (₹)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#each topCustomers}}
                            <tr class="{{#eq this.customer_id ../data.customer_id}}table-primary{{/eq}}">
                                <td class="text-center">{{this.sales_rank}}</td>
                                <td>
                                    {{this.customer_name}} ({{this.city}})
                                </td>
                                <td class="text-end">{{formatNumber this.total_quantity}}</td>
                                <td class="text-end">{{formatCurrency this.total_sales}}</td>
                            </tr>
                            {{/each}}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>        
    </div>

    <div class="row justify-content-center mt-4">
        <div class="col-lg-11 border p-4 rounded">
            <h4 class="mb-3">Sales Performance</h4>

            <!-- Sales Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary mb-3 h-100">
                        <div class="card-body">
                            <h6 class="card-title">Total Quantity</h6>
                            <p class="card-text display-6">{{formatNumber salesSummary.totalQty}}</p>
                            <p class="card-text"><small>Given Dates</small></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success mb-3 h-100">
                        <div class="card-body">
                            <h6 class="card-title">Total Value</h6>
                            <p class="card-text display-6">{{formatCurrency salesSummary.totalValue}}</p>
                            <p class="card-text"><small>Given Dates</small></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info mb-3 h-100">
                        <div class="card-body">
                            <h6 class="card-title">Avg. Monthly</h6>
                            <p class="card-text display-6">{{formatCurrency salesSummary.avgMonthly}}</p>
                            <p class="card-text"><small>Monthly Average</small></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-secondary mb-3 h-100">
                        <div class="card-body">
                            <h6 class="card-title">Categories</h6>
                            <p class="card-text display-6">{{salesSummary.categoryCount}}</p>
                            <p class="card-text"><small>Product Categories</small></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Material Group Performance -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Sales by Product Category</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover" id="materialGroupTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Category</th>
                                            <th class="text-end">Qty (Bags)</th>
                                            <th class="text-end">Value (₹)</th>
                                            <th class="text-end">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{#each materialGroupPerformance}}
                                        <tr>
                                            <td>{{this.material_group_description}}</td>
                                            <td class="text-end">{{formatNumber this.quantity}}</td>
                                            <td class="text-end">{{formatCurrency this.total_value}}</td>
                                            <td class="text-end">{{formatNumber this.percent_value}}%</td>
                                        </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Category Distribution</h5>
                        </div>
                        <div class="card-body" style="position: relative; height: 250px;">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monthly Trend Chart -->
            <div class="row">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Monthly Sales Trend</h5>
                        </div>
                        <div class="card-body" style="position: relative; height: 300px;">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Work Person Details Section -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-11 border p-4 rounded">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Work Person Details</h4>
                <span class="badge bg-primary">{{wpData.length}} Persons</span>
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-hover" id="wpTable">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Education</th>
                            <th>Birth Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each wpData}}
                        <tr>
                            <td>{{this.sr_no}}</td>
                            <td>{{this.wp_type}}</td>
                            <td>{{this.wp_name}}</td>
                            <td>{{this.wp_mobile}}</td>
                            <td>{{this.wp_edu}}</td>
                            <td>{{momentYMD this.wp_dob}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Vehicle Details Section -->
    <div class="row justify-content-center mt-4">
        <div class="col-lg-11 border p-4 rounded">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Vehicle Details</h4>
                <span class="badge bg-primary">{{vehData.length}} Vehicles</span>
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-hover" id="vehTable">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Reg No</th>
                            <th>Type</th>
                            <th>Insurance No</th>
                            <th>Expiry Date</th>
                            <th class="text-end">Routes</th>
                            <th class="text-end">Outlets</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each vehData}}
                        <tr>
                            <td>{{this.sr_no}}</td>
                            <td class="text-uppercase">{{this.reg_no}}</td>
                            <td>{{this.veh_type}}</td>
                            <td>{{this.ins_no}}</td>
                            <td>{{momentYMD this.ins_date}}</td>
                            <td class="text-end">{{this.routes}}</td>
                            <td class="text-end">{{this.outlets}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Salesman Details Section -->
    <div class="row justify-content-center mt-4 mb-5">
        <div class="col-lg-11 border p-4 rounded">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Salesman Details</h4>
                <span class="badge bg-primary">{{spData.length}} Salesmen</span>
            </div>

            <div class="table-responsive">
                <table class="table table-sm table-hover" id="spTable">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Type</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Education</th>
                            <th class="text-end">Exp (Yrs)</th>
                            <th class="text-end">Salary</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each spData}}
                        <tr>
                            <td>{{this.sr_no}}</td>
                            <td>{{this.sp_type}}</td>
                            <td>{{this.sp_name}}</td>
                            <td>{{this.sp_mobile}}</td>
                            <td>{{this.sp_edu}}</td>
                            <td class="text-end">{{this.sp_year}}</td>
                            <td class="text-end">{{formatCurrency this.sp_salary}}</td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>


<script>
    // Prepare data for charts
    const categoryLabels = [
        {{#each materialGroupPerformance}}
        "{{this.material_group_description}}",
        {{/each}}
    ];

    const categoryData = [
        {{#each materialGroupPerformance}}
        {{this.total_value}},
        {{/each}}
    ];

    const trendLabels = [
        {{#each monthlyTrend}}
        "{{this.month}}",
        {{/each}}
    ];

    const trendData = [
        {{#each monthlyTrend}}
        {{this.total_value}},
        {{/each}}
    ];
</script>

<script>
    $(document).ready(function () {
        // Initialize DataTables
        $('#materialGroupTable').DataTable({
            order: [[1, 'desc']],
            pageLength: 5,
            dom: '<"top"i>rt<"bottom"lp><"clear">',
            responsive: true
        });

        $('#wpTable').DataTable({
            pageLength: 5,
            dom: '<"top"i>rt<"bottom"lp><"clear">',
            responsive: true
        });

        $('#vehTable').DataTable({
            pageLength: 5,
            dom: '<"top"i>rt<"bottom"lp><"clear">',
            responsive: true
        });

        $('#spTable').DataTable({
            pageLength: 5,
            dom: '<"top"i>rt<"bottom"lp><"clear">',
            responsive: true
        });


        // Category Distribution Chart
        if (categoryLabels.length > 0) {
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        data: categoryData,
                        backgroundColor: [
                            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e',
                            '#e74a3b', '#858796', '#5a5c69', '#3a3b45'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        // Monthly Trend Chart
        if (trendLabels.length > 0) {
            const trendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
            const trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Sales Value (₹)',
                        data: trendData,
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointRadius: 3,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    });
</script>